<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Login • GRUPO DV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    :root{
      --bg:#f6f8fb; --ink:#0f172a; --muted:#64748b; --card:#fff; --primary:#0ea5e9;
      --shadow:0 10px 30px rgba(2,6,23,.12);
    }
    html,body{height:100%; -webkit-text-size-adjust:100%}
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:'Segoe UI',system-ui,-apple-system,Roboto,Arial,sans-serif;
      overflow-x:hidden;
    }
    .wrap{
      min-height:100dvh; display:grid; place-items:center; padding:14px;
    }
    .filters{
  display: grid;
  grid-template-columns: minmax(180px,1fr) 180px 180px 180px;
  gap: 12px;
  align-items: end;
}

    .card{
      width:clamp(280px, 92vw, 420px);
      background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:18px;
    }
    .brand{display:flex; align-items:center; gap:10px; margin-bottom:10px}
    .brand img{height:40px; width:auto}
    h1{font-size:18px; margin:0; line-height:1.2}
    .muted{
      color:var(--muted); font-size:13px; margin:6px 0 14px;
      word-break:break-word; white-space:normal;
    }
    label{display:block; font-size:13px; margin:10px 0 6px; color:#334155}
    input{
      width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;
      font-size:16px; /* 16px evita zoom no iOS */
    }
    .row{display:flex; gap:8px; align-items:center; margin-top:12px}
    .btn{
      width:100%; padding:12px 14px; border:none; border-radius:999px; background:var(--primary);
      color:#fff; font-weight:600; cursor:pointer; font-size:16px;
    }
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .err,.ok{
      border-radius:12px; padding:10px 12px; font-size:13px; display:none; margin-top:10px;
      word-break:break-word;
    }
    .err{background:#fef2f2; color:#991b1b; border:1px solid #fecaca}
    .ok{background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0}
    .footer{margin-top:14px; font-size:12px; color:var(--muted); text-align:center}
    .field{position:relative}
    .toggle{
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      font-size:12px; color:#0369a1; background:#e0f2fe; border:1px solid #bae6fd;
      border-radius:999px; padding:2px 8px; cursor:pointer; line-height:18px;
    }
    .remember{display:flex; align-items:center; gap:8px; margin-top:8px; font-size:13px; color:#334155}
    .remember input{width:auto}
    /* telas bem pequenas */
    @media (max-width:340px){
      .muted{font-size:12px}
      label{font-size:12px}
      .remember{font-size:12px}
      h1{font-size:16px}
    }
  </style>
<script>
(function(){
  const KEY_NAME = 'dv_pwd';
  async function ensurePassword(){
    let pwd = localStorage.getItem(KEY_NAME) || '';
    while(!pwd){
      pwd = prompt('Digite a senha de acesso:') || '';
      if(!pwd) continue;
      try{
        const r = await fetch('/api/ping', {headers:{'x-api-key': pwd }});
        if(r.ok){
          localStorage.setItem(KEY_NAME, pwd);
          break;
        }else{
          alert('Senha incorreta.');
          pwd = '';
        }
      }catch(e){
        // se não der pra validar agora, ainda assim salva e segue
        localStorage.setItem(KEY_NAME, pwd);
        break;
      }
    }
  }

  // intercepta fetch para anexar a senha automaticamente
  const _fetch = window.fetch.bind(window);
  window.fetch = (input, init={})=>{
    let url = (typeof input === 'string') ? input : (input && input.url) || '';
    init = init || {};
    const headers = new Headers(init.headers || ((typeof input !== 'string' && input.headers) || {}));
    const pwd = localStorage.getItem(KEY_NAME) || '';
    if(url.startsWith('/api/')){
      if(pwd) headers.set('x-api-key', pwd);
    }
    return _fetch(input, Object.assign({}, init, { headers }));
  };

  // pede a senha apenas se ainda não houver
  if(!localStorage.getItem(KEY_NAME)){
    ensurePassword();
  }
})();
</script>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="brand">
        <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo" />
        <h1>Entrar</h1>
      </div>
      <div class="muted">Use seu usuário e senha. A validação ocorre no servidor (planilha privada).</div>

      <form id="form">
        <label for="usuario">Usuário</label>
        <input id="usuario" name="usuario" autocomplete="username" autocapitalize="none" inputmode="text" required />

        <label for="senha">Senha</label>
        <div class="field">
          <input id="senha" name="senha" type="password" autocomplete="current-password" required />
          <button class="toggle" type="button" id="toggle">mostrar</button>
        </div>

        <label class="remember" title="Mantém a sessão ativa neste aparelho">
          <input type="checkbox" id="remember" />
          Manter conectado
        </label>

        <div class="row">
          <button class="btn" id="btn" type="submit">Entrar</button>
        </div>
        <div class="err" id="err"></div>
        <div class="ok" id="ok"></div>
      </form>

      <div class="footer">Dica: em computador compartilhado, desmarque “manter conectado”.</div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const WEBAPP = '/api/login_api';

    // ====== Helpers ======
    const qs = (id)=>document.getElementById(id);
    const setBusy = (b)=>{ qs('btn').disabled=b; qs('btn').textContent=b?'Verificando…':'Entrar'; }
    const showErr = (m)=>{ const el=qs('err'); el.textContent=m||''; el.style.display=m?'block':'none'; qs('ok').style.display='none'; }
    const showOk  = (m)=>{ const el=qs('ok');  el.innerHTML=m||''; el.style.display=m?'block':'none'; qs('err').style.display='none'; }

    function getRedirectUrl(){
      const cur = new URL(location.href);
      const next = cur.searchParams.get('next');
      const base = cur.href.slice(0, cur.href.lastIndexOf('/') + 1);
      const def  = base + 'index.html';
      try { return next ? new URL(next, cur).href : def; } catch { return def; }
    }
    function hardRedirect(dest){
      // remove login do histórico
      location.replace(dest);
      // fallback: se algum navegador ignorar o replace
      setTimeout(()=>{ if (/login\.html?/i.test(location.href)) location.href = dest; }, 150);
    }

    function deviceId(){
      const k='dv_device_id';
      let v=localStorage.getItem(k);
      if(!v){ v=(crypto.randomUUID?.() || (Date.now().toString(36)+Math.random().toString(36).slice(2))); localStorage.setItem(k,v); }
      return v;
    }
    function saveSession(j){
      localStorage.setItem('auth_token', j.token);
      localStorage.setItem('auth_user', JSON.stringify({usuario:j.usuario, empresa:j.empresa, perfil:j.perfil}));
    }

    // ====== SKIP LOGIN SE JÁ TEM SESSÃO ======
    (function skipIfLogged(){
      if (localStorage.getItem('auth_token')) {
        hardRedirect(getRedirectUrl());
      }
    })();

    // UI
    qs('toggle').addEventListener('click', ()=>{
      const f=qs('senha'); const isPw=f.type==='password';
      f.type = isPw ? 'text' : 'password';
      qs('toggle').textContent = isPw ? 'ocultar' : 'mostrar';
      f.focus();
    });

    // ====== LOGIN ======
    qs('form').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      showErr(''); showOk('');
      const usuario = qs('usuario').value.trim();
      const senha   = qs('senha').value;
      const remember= qs('remember').checked;
      if(!usuario || !senha){ showErr('Preencha usuário e senha.'); return; }

      setBusy(true);
      try{
        const r = await fetch(`${WEBAPP}?fn=login`, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=UTF-8' }, // sem preflight
          body: JSON.stringify({
            usuario, senha, remember,
            device: { id:deviceId(), ua:navigator.userAgent, w:innerWidth, h:innerHeight }
          })
        });
        const raw = await r.text();
        let j; try{ j=JSON.parse(raw); }catch{ showErr('Resposta inválida do servidor.'); setBusy(false); return; }

        if (j.status === 'pending'){
          showOk('✅ Dispositivo registrado. Aguarde o administrador liberar este aparelho e tente novamente.');
          setBusy(false);
          return;
        }
        if (!j.ok){
          if(j.error==='blocked') showErr(`Muitas tentativas. Tente novamente em ${j.minutes} min.`);
          else if(j.error==='invalid_credentials') showErr('Usuário ou senha inválidos.');
          else showErr('Não foi possível entrar agora.');
          setBusy(false);
          return;
        }

        saveSession(j);
        const dest = getRedirectUrl();
        showOk(`Acesso autorizado. Redirecionando… Se não for automático, <a href="${dest}">clique aqui</a>.`);
        setTimeout(()=>hardRedirect(dest), 80);
      }catch{
        showErr('Falha de rede. Tente novamente.');
      }finally{
        setBusy(false);
      }
    });
  </script>
</body>
</html>
