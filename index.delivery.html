<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Vendas Delivery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b1020; --surface:#10172a; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --line:rgba(148,163,184,.25); --icon-bg:rgba(255,255,255,.06); --shadow:0 20px 60px rgba(2,6,23,.35);
      --brand:#60a5fa; --brand2:#22d3ee; --success:#16a34a; --danger:#dc2626; --orange:#f59e0b;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --surface:#fff; --card:#fff; --text:#0f172a; --muted:#475569;
      --line:#e5e7eb; --icon-bg:rgba(2,6,23,.06); --shadow:0 16px 36px rgba(15,23,42,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }

    /* Header */
    header{position:sticky; top:0; z-index:40; backdrop-filter:saturate(160%) blur(8px);
      background:color-mix(in srgb, var(--surface) 80%, transparent); border-bottom:1px solid var(--line);}
    .head{max-width:1200px; margin:0 auto; padding:14px 18px; display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit}
    .brand img{height:42px}
    .title{font-weight:800; letter-spacing:.2px; font-size:clamp(18px,1.6vw,22px)}
    .grow{flex:1}
    .btn{border:1px solid var(--line); background:var(--surface); color:var(--text);
      padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer; display:inline-flex; gap:8px; align-items:center}
    .btn:hover{box-shadow:var(--shadow); transform:translateY(-1px)}
    .only-desktop{display:inline-flex}
    @media (max-width:900px){.only-desktop{display:none!important}}

    .user{position:relative}
    .user-btn{display:flex; align-items:center; gap:10px; border:1px solid var(--line);
      background:var(--surface); padding:6px 8px; border-radius:999px; cursor:pointer}
    .user-btn img{width:34px; height:34px; border-radius:50%; object-fit:cover; background:var(--icon-bg)}
    .user-menu{position:absolute; right:0; top:110%; background:var(--surface); border:1px solid var(--line);
      border-radius:12px; min-width:200px; padding:6px; box-shadow:var(--shadow); display:none}
    .user.open .user-menu{display:block}
    .user-menu a,.user-menu button{display:flex; width:100%; padding:10px 12px; border-radius:10px;
      border:none; background:transparent; color:var(--text); text-align:left; cursor:pointer; font-weight:600}
    .user-menu a:hover,.user-menu button:hover{background:var(--icon-bg)}

    /* P√°gina */
    .container { padding: 20px; max-width: 100%; margin: 0; }
    @media (max-width: 768px){ .container{ padding:10px; } }

    /* Filtros ‚Äì grid flex√≠vel:
       1¬™ coluna (Empresa) cresce para caber o nome completo; meses fixos; bot√£o fixo. */
    .filters{
      display:grid;
      grid-template-columns: minmax(340px,2fr) 160px 160px 200px;
      gap:12px; align-items:end;
    }
    /* telas m√©dias: um pouco mais compactas mantendo leitura */
    @media (max-width:1200px){
      .filters{ grid-template-columns: minmax(260px,1fr) 150px 150px 160px; }
    }
    /* tablets: 2 colunas */
    @media (max-width:900px){
      .filters{ grid-template-columns: 1fr 1fr; }
    }
    /* celular: 1 coluna */
    @media (max-width:600px){
      .filters{ grid-template-columns: 1fr; }
    }
    .field{min-width:0;} /* permite o campo Empresa expandir sem quebrar layout */
    .field label{display:block; margin:0 0 6px; color:var(--muted); font-weight:800; font-size:.95rem}
    select{
      width:100%; border:1px solid var(--line); background:var(--surface); color:var(--text);
      border-radius:12px; padding:12px 14px; font-weight:700; font-size:14px;
    }
    .btn-whats{background:#25d366; color:#fff; border-color:#21b75a}

    /* Cards/caixas */
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:var(--shadow); margin:14px 0}
    .card h3{margin:0 0 10px}
    .total-line{display:flex; justify-content:space-between; padding:6px 0; font-weight:800}

    /* Gr√°fico principal mais ‚Äúestreito‚Äù */
    #graficoVendas{ width:100%; height:220px !important; }
    @media (max-width:768px){ #graficoVendas{ height:170px !important; } }

    /* Tabelas */
    table{width:100%; border-collapse:collapse; font-size:.95rem}
    th,td{padding:10px; border-bottom:1px solid var(--line)}
    th{color:var(--muted); text-align:left}
    td:last-child, th:last-child{text-align:right}

    /* Ranking rol√°vel + coluna ‚ÄúM√™s‚Äù fixa √† esquerda */
    .table-scroll{overflow-x:auto; -webkit-overflow-scrolling:touch}
    .ranking-table{white-space:nowrap; min-width:720px}
    .ranking-table thead th{position:sticky; top:0; background:var(--surface); z-index:1}
    .ranking-table th:first-child,
    .ranking-table td:first-child{
      position:sticky; left:0; background:var(--surface); z-index:2;
    }

    /* Resumo por empresa (cards clic√°veis) */
    .resumo-linha{background:var(--card); border:2px solid var(--line); border-radius:12px; padding:14px; margin-bottom:12px; box-shadow:var(--shadow);
      transition:.18s transform, .18s box-shadow, .18s border-color; cursor:pointer}
    .resumo-linha:hover{transform:translateY(-2px)}
    .plat-ifood{border-color: color-mix(in srgb, var(--danger) 70%, var(--line))}
    .plat-much{border-color: color-mix(in srgb, var(--orange) 70%, var(--line))}
    .resumo-linha strong{display:block; margin-bottom:6px}

    /* Loading overlay */
    .loading{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:60}
    .loading.show{display:flex}
    .spinner{width:74px; height:74px; border-radius:50%; border:6px solid rgba(255,255,255,.25); border-top-color:#fff; animation:spin 1s linear infinite}
    .loading p{color:#fff; font-weight:800; margin-top:12px; text-shadow:0 2px 6px rgba(0,0,0,.3)}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Modal evolu√ß√£o por modalidade */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:55; padding:18px}
    .modal.open{display:flex}
    .modal-card{background:var(--surface); border:1px solid var(--line); border-radius:14px; width:min(1100px,96vw); max-height:92vh;
      box-shadow:var(--shadow); padding:16px; overflow:auto}
    .modal-h{display:flex; align-items:center; gap:10px; margin-bottom:8px}
    .close{margin-left:auto; cursor:pointer; font-weight:800; color:var(--muted)}
    #modalChart{width:100%!important; height:360px!important}
  </style>

  <!-- prote√ß√£o por senha + tema + fetch x-api-key -->
  <script>
    (function(){
      const KEY='dv_pwd';
      const t=localStorage.getItem('dv_theme'); if(t) document.documentElement.setAttribute('data-theme', t);

      window.__toggleTheme = function(){
        const cur=document.documentElement.getAttribute('data-theme')||'light';
        const next=(cur==='light')?'dark':'light';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('dv_theme', next);
      };

      async function ensurePwd(){
        let pwd=localStorage.getItem(KEY)||'';
        while(!pwd){
          pwd=prompt('Digite a senha de acesso:')||'';
          if(!pwd) continue;
          try{
            const r=await fetch('/api/ping',{headers:{'x-api-key':pwd}});
            if(r.ok){ localStorage.setItem(KEY,pwd); break; }
            alert('Senha incorreta.'); pwd='';
          }catch{ localStorage.setItem(KEY,pwd); break; }
        }
      }

      const _f=window.fetch.bind(window);
      window.fetch=(input,init={})=>{
        const url=(typeof input==='string')?input:(input&&input.url)||'';
        const headers=new Headers(init.headers||((typeof input!=='string'&&input.headers)||{}));
        const pwd=localStorage.getItem(KEY)||'';
        if(url.startsWith('/api/') && pwd) headers.set('x-api-key', pwd);
        return _f(input, Object.assign({}, init, {headers}));
      };

      if(!localStorage.getItem(KEY)) ensurePwd();
      window.handleLogout = ()=>{ localStorage.removeItem(KEY); location.reload(); }
    })();
  </script>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="head">
      <a class="brand" href="index.html">
        <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo">
        <span class="title">Vendas Delivery</span>
      </a>
      <div class="grow"></div>
      <a class="btn only-desktop" href="index.relatorios.html">üìÑ Relat√≥rios</a>
      <button id="themeToggle" class="btn">üåì Tema</button>
      <div class="user" id="userMenu">
        <button class="user-btn" type="button">
          <img src="https://github.com/ClenaStore/grupodv/blob/main/paste/Imagem%20do%20WhatsApp%20de%202025-09-08%20%C3%A0(s)%2011.54.12_884bebc9.jpg?raw=true" alt="">
          <strong style="font-size:13px">Leonardo</strong>
        </button>
        <div class="user-menu">
          <a href="perfil.html">üë§ Meu Perfil</a>
          <button onclick="handleLogout()">üö™ Sair</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Loading overlay -->
  <div id="loading" class="loading" aria-hidden="true">
    <div style="display:flex; flex-direction:column; align-items:center;">
      <div class="spinner"></div>
      <p>Carregando dados...</p>
    </div>
  </div>

  <div class="container">
    <!-- Filtros -->
    <div class="filters">
      <div class="field">
        <label for="empresaFiltro">Empresa</label>
        <select id="empresaFiltro"></select>
      </div>
      <div class="field">
        <label for="mesInicio">M√™s in√≠cio</label>
        <select id="mesInicio">
          <option value="">Todos</option>
          <option value="01">Janeiro</option><option value="02">Fevereiro</option><option value="03">Mar√ßo</option>
          <option value="04">Abril</option><option value="05">Maio</option><option value="06">Junho</option>
          <option value="07">Julho</option><option value="08">Agosto</option><option value="09">Setembro</option>
          <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
        </select>
      </div>
      <div class="field">
        <label for="mesFim">M√™s fim</label>
        <select id="mesFim">
          <option value="">Todos</option>
          <option value="01">Janeiro</option><option value="02">Fevereiro</option><option value="03">Mar√ßo</option>
          <option value="04">Abril</option><option value="05">Maio</option><option value="06">Junho</option>
          <option value="07">Julho</option><option value="08">Agosto</option><option value="09">Setembro</option>
          <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
        </select>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button id="btnWhats" class="btn btn-whats" type="button">üì≤ WhatsApp</button>
      </div>
    </div>

    <!-- Gr√°fico -->
    <div class="card">
      <h3>üìà Vendas Brutas por M√™s</h3>
      <canvas id="graficoVendas"></canvas>
    </div>

    <!-- M√©dia mensal -->
    <div class="card">
      <h3>üìä M√©dia por M√™s</h3>
      <div class="total-line"><span>M√©dia</span><strong id="media-mensal">R$ 0,00</strong></div>
    </div>

    <!-- Totais por plataforma -->
    <div class="card">
      <h3>üß© Totais por Plataforma</h3>
      <table>
        <thead><tr><th>Plataforma</th><th>Total</th></tr></thead>
        <tbody id="tabela-plataformas"></tbody>
      </table>
    </div>

    <!-- Ranking (rol√°vel com m√™s travado) -->
    <div class="card">
      <h3>üèÜ Ranking de Empresas</h3>
      <div class="table-scroll">
        <table class="ranking-table">
          <thead></thead>
          <tbody id="tabela-ranking"></tbody>
        </table>
      </div>
    </div>

    <!-- Resumo -->
    <div class="card">
      <h3>üì¶ Resumo por Empresa</h3>
      <div id="resumo-empresas"></div>
    </div>
  </div>

  <!-- Modal evolu√ß√£o (empresa + modalidade) -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-h">
        <h3 id="modalTitle" style="margin:0">Evolu√ß√£o</h3>
        <span id="closeModal" class="close">‚úï</span>
      </div>
      <canvas id="modalChart"></canvas>
    </div>
  </div>

<script>
/* ---------- Tema & menu usu√°rio ---------- */
document.getElementById('themeToggle').addEventListener('click', ()=>window.__toggleTheme && window.__toggleTheme());
const user = document.getElementById('userMenu');
user.querySelector('.user-btn').addEventListener('click', ()=>user.classList.toggle('open'));
window.addEventListener('click', e=>{ if(!user.contains(e.target)) user.classList.remove('open'); });

/* ---------- Util ---------- */
const URL_SCRIPT = "/api/delivery";
let dados = [];
let chart, modalChart;
const $ = sel => document.querySelector(sel);
function showLoading(v){ $('#loading').classList.toggle('show', !!v); }
const BRL = n => (Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2});

/* Tooltip via clique/touch (mobile) */
function wireTooltipOnClick(chart, canvasId){
  const el = document.getElementById(canvasId);
  function activate(evt){
    const pts = chart.getElementsAtEventForMode(evt, 'nearest', {intersect:true}, true);
    if(!pts.length) return;
    const {datasetIndex, index} = pts[0];
    const node = chart.getDatasetMeta(datasetIndex).data[index];
    chart.setActiveElements([{datasetIndex, index}]);
    chart.tooltip.setActiveElements([{datasetIndex, index}], {x: node.x, y: node.y});
    chart.update();
  }
  el.addEventListener('click', activate, {passive:true});
  el.addEventListener('touchstart', activate, {passive:true});
}

/* ---------- Filtros helpers ---------- */
function getFiltros() {
  const empresa = $('#empresaFiltro').value;
  const mesInicio = $('#mesInicio').value;
  const mesFim = $('#mesFim').value;

  return dados.filter(d => {
    const mes = d.data.split("-")[1];
    return (!empresa || d.empresa === empresa) &&
           (!mesInicio || mes >= mesInicio) &&
           (!mesFim || mes <= mesFim);
  });
}

/* ---------- Atualiza√ß√µes ---------- */
function atualizarTudo(){
  atualizarResumoEmpresa();
  filtrarGrafico();
  atualizarMediaMensal();
  atualizarTotaisPorPlataforma();
  atualizarRankingEmpresas();
}

function filtrarGrafico() {
  const filtrados = getFiltros();
  const agg = {};
  filtrados.forEach(d => {
    const mes = d.data.slice(0,7);
    agg[mes] = (agg[mes] || 0) + parseFloat(d.bruto || 0);
  });

  const labels = Object.keys(agg).sort();
  const valores = labels.map(l => agg[l]);

  if (chart) chart.destroy();
  chart = new Chart($('#graficoVendas'), {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Bruto por M√™s',
        data: valores,
        borderColor: '#60a5fa',
        backgroundColor: 'rgba(96,165,250,.18)',
        borderWidth: 3,
        pointRadius: 5,
        pointHoverRadius: 8,
        pointHitRadius: 28,
        tension: .25,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,      // respeita altura do CSS
      interaction:{mode:'nearest', intersect:false, axis:'x'},
      plugins: {
        legend: { display: false },
        tooltip: { intersect:false, callbacks:{ label:c=>'R$ '+BRL(c.parsed.y) } }
      },
      scales: {
        y: { beginAtZero: true, ticks: { callback:v=>'R$ '+v.toLocaleString('pt-BR') } }
      }
    }
  });
  wireTooltipOnClick(chart, 'graficoVendas');
}

function atualizarMediaMensal() {
  const filtrados = getFiltros();
  const agg = {};
  filtrados.forEach(d => {
    const mes = d.data.slice(0,7);
    agg[mes] = (agg[mes] || 0) + parseFloat(d.bruto || 0);
  });
  const valores = Object.values(agg);
  const media = valores.length ? valores.reduce((a,b)=>a+b,0)/valores.length : 0;
  $('#media-mensal').textContent = 'R$ ' + BRL(media);
}

function atualizarTotaisPorPlataforma() {
  const filtrados = getFiltros();
  const totais = {};
  filtrados.forEach(d => {
    totais[d.plataforma] = (totais[d.plataforma] || 0) + parseFloat(d.bruto || 0);
  });
  const el = $('#tabela-plataformas');
  el.innerHTML = '';
  Object.entries(totais).forEach(([plat, val]) => {
    el.innerHTML += `<tr><td>${plat}</td><td>R$ ${BRL(val)}</td></tr>`;
  });
}

function atualizarRankingEmpresas() {
  const filtrados = getFiltros();
  const dadosMesEmpresa = {};
  filtrados.forEach(d => {
    const mes = d.data.slice(0,7);
    const emp = d.empresa;
    const val = parseFloat(d.bruto || 0);
    if(!dadosMesEmpresa[mes]) dadosMesEmpresa[mes]={};
    if(!dadosMesEmpresa[mes][emp]) dadosMesEmpresa[mes][emp]=0;
    dadosMesEmpresa[mes][emp]+=val;
  });

  const nomesMes = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  const meses = Object.keys(dadosMesEmpresa).sort().reverse();
  const empresas = [...new Set(filtrados.map(d=>d.empresa))].sort();

  const tbody = $('#tabela-ranking');
  const thead = tbody.parentElement.parentElement.querySelector('thead');
  thead.innerHTML = `<tr><th>M√™s</th>${empresas.map(e=>`<th>${e}</th>`).join('')}</tr>`;
  tbody.innerHTML='';

  meses.forEach(m=>{
    const [ano,mm]=m.split('-');
    const linha=[`<td>${nomesMes[+mm-1]}/${ano}</td>`];
    const vals = empresas.map(e=>dadosMesEmpresa[m][e]||0);
    const max = Math.max(...vals);
    empresas.forEach((e,i)=>{
      const v = vals[i];
      const strong = v===max ? ` style="color:var(--success); font-weight:800"` : '';
      linha.push(`<td${strong}>R$ ${BRL(v)}</td>`);
    });
    tbody.innerHTML += `<tr>${linha.join('')}</tr>`;
  });
}

function atualizarResumoEmpresa() {
  const filtrados = getFiltros();
  const resumo = {};
  filtrados.forEach(d => {
    const chave = `${d.empresa} | ${d.plataforma}`;
    if (!resumo[chave]) resumo[chave] = { bruto: 0, liquido: 0, taxa: 0 };
    resumo[chave].bruto += parseFloat(d.bruto || 0);
    resumo[chave].liquido += parseFloat(d.liquido || 0);
    resumo[chave].taxa += parseFloat(d.taxa || 0);
  });

  const box = $('#resumo-empresas'); box.innerHTML='';
  Object.entries(resumo).sort().forEach(([k,v])=>{
    const [empresa, plataforma] = k.split(' | ');
    const perc = (v.taxa / (v.bruto||1)) * 100;
    const plat = plataforma.toLowerCase();
    const classePlat = plat.includes('ifood') ? 'plat-ifood' : (plat.includes('much') ? 'plat-much' : '');

    const div = document.createElement('div');
    div.className = `resumo-linha ${classePlat}`;
    div.dataset.empresa = empresa;
    div.dataset.plataforma = plataforma;
    div.innerHTML = `
      <strong>${empresa} ‚Äî ${plataforma}</strong>
      üí∞ Bruto: R$ ${BRL(v.bruto)}<br>
      üíµ L√≠quido: R$ ${BRL(v.liquido)}<br>
      üìâ Investimento (${perc.toFixed(2)}%): R$ ${BRL(v.taxa)}
    `;
    div.addEventListener('click', ()=>abrirModalEvolucao(empresa, plataforma));
    box.appendChild(div);
  });
}

/* ---------- Modal: evolu√ß√£o empresa + modalidade ---------- */
function abrirModalEvolucao(empresa, plataforma){
  const filtrados = getFiltros().filter(d=> d.empresa===empresa && d.plataforma===plataforma);
  const agg = {};
  filtrados.forEach(d=>{
    const mes = d.data.slice(0,7);
    agg[mes] = (agg[mes]||0) + parseFloat(d.bruto||0);
  });
  const labels = Object.keys(agg).sort();
  const valores = labels.map(l=>agg[l]);

  $('#modalTitle').textContent = `Evolu√ß√£o ‚Äî ${empresa} ‚Äî ${plataforma}`;
  $('#modal').classList.add('open');

  const border = plataforma.toLowerCase().includes('ifood') ? '#dc2626' :
                 plataforma.toLowerCase().includes('much') ? '#f59e0b' : '#2563eb';
  const fill = plataforma.toLowerCase().includes('ifood') ? 'rgba(220,38,38,.15)' :
               plataforma.toLowerCase().includes('much') ? 'rgba(245,158,11,.15)' : 'rgba(37,99,235,.15)';

  if(modalChart) modalChart.destroy();
  modalChart = new Chart(document.getElementById('modalChart'),{
    type:'line',
    data:{labels, datasets:[{label:`${plataforma}`, data:valores, borderColor:border, backgroundColor:fill,
      borderWidth:3, pointRadius:5, pointHoverRadius:8, pointHitRadius:28, tension:.25, fill:true}]},
    options:{
      responsive:true,
      interaction:{mode:'nearest', intersect:false, axis:'x'},
      plugins:{ tooltip:{intersect:false, callbacks:{label:c=>'R$ '+BRL(c.parsed.y)}}},
      scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>'R$ '+v.toLocaleString('pt-BR') } } }
    }
  });
  wireTooltipOnClick(modalChart, 'modalChart');
}
document.getElementById('closeModal').addEventListener('click', ()=>document.getElementById('modal').classList.remove('open'));
document.getElementById('modal').addEventListener('click', e=>{ if(e.target.id==='modal') document.getElementById('modal').classList.remove('open'); });

/* ---------- WhatsApp ---------- */
document.getElementById('btnWhats').addEventListener('click', ()=>{
  const empresa = $('#empresaFiltro').value || 'TODAS';
  const media = $('#media-mensal').textContent;
  const msg = `üìä Resumo de Vendas Delivery\nüè¢ Empresa: ${empresa}\nüìà M√©dia: ${media}`;
  const url = `https://wa.me/557799999999?text=${encodeURIComponent(msg)}`;
  window.open(url,'_blank');
});

/* ---------- Carregamento inicial ---------- */
async function carregarDados(){
  showLoading(true);
  try{
    const res = await fetch(URL_SCRIPT);
    dados = await res.json();
    // popular empresas
    const empresas = [...new Set(dados.map(d=>d.empresa))].sort();
    const sel = $('#empresaFiltro'); sel.innerHTML = `<option value="">TODAS</option>`;
    empresas.forEach(emp=>{
      const o=document.createElement('option'); o.value=emp; o.textContent=emp; sel.appendChild(o);
    });
    // reagir a mudan√ßas
    ['empresaFiltro','mesInicio','mesFim'].forEach(id=>document.getElementById(id).onchange = atualizarTudo);
    atualizarTudo();
  }catch(e){
    console.error(e);
    alert('Erro ao carregar dados do delivery.');
  }finally{
    showLoading(false);
  }
}
carregarDados();
</script>
</body>
</html>
